db.grades.aggregate([{$unwind: '$scores' } , {$match : { 'scores.type':{$in : ['exam','homework']}  }},{$group: { _id : { 'class_id':'$class_id','student_id':'$student_id' } , std_avg: {$avg : '$scores.score'}  }  }	, {$project : { _id:0,'_id.class_id':1 , std_avg:1     }  } , { $group : { _id : '$_id.class_id' , avg_class: {$avg: '$std_avg'}    }     } , {$sort : { 'avg_class':-1  }}   ])